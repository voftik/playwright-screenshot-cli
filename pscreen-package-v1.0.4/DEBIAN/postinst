#!/bin/bash

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PScreen v1.0.4..."

cd /usr/local/lib/pscreen

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
if [ ! -d "node_modules" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    npm install --production --silent --force 2>/dev/null || {
        echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ npm..."
        npm install --production --force
    }
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Playwright –±—Ä–∞—É–∑–µ—Ä—ã
if [ ! -d "node_modules/playwright/.local-browsers" ]; then
    echo "üåê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright..."
    npx playwright install chromium --with-deps >/dev/null 2>&1 || {
        echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright..."
        npx playwright install chromium --with-deps
    }
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
mkdir -p /var/lib/pscreen/results
chmod 755 /var/lib/pscreen/results

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f "node.*pscreen\|node.*src" 2>/dev/null || true

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
chmod +x /usr/local/bin/pscreen
chmod -R 755 /usr/local/lib/pscreen

echo "‚úÖ PScreen v1.0.4 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üÜï –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ v1.0.4:"
echo "   ‚Ä¢ –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (pscreen serve-standalone)"
echo "   ‚Ä¢ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫"
echo "   ‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (pscreen --debug)"
echo "   ‚Ä¢ –ù–∞–¥–µ–∂–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö"
echo ""
echo "üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
echo "   pscreen                    - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"
echo "   pscreen serve              - –í–µ–±-—Å–µ—Ä–≤–µ—Ä"
echo "   pscreen serve-standalone   - –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Å–µ—Ä–≤–µ—Ä"
echo "   pscreen --debug            - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"
echo "   pscreen --fix              - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"

exit 0
