#!/bin/bash

# PScreen CLI Tool v1.0.4
APP_DIR="/usr/local/lib/pscreen"

if [ ! -d "$APP_DIR" ]; then
    echo "‚ùå PScreen –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    exit 1
fi

cd "$APP_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
if [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
    echo "PScreen CLI Tool v1.0.4"
    exit 0
fi

if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "PScreen - –£–ª—É—á—à–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  pscreen                    - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"
    echo "  pscreen <url>              - –ë—ã—Å—Ç—Ä—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç URL"
    echo "  pscreen serve              - –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
    echo "  pscreen serve-standalone   - –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"
    echo "  pscreen --version          - –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é"
    echo "  pscreen --help             - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"
    echo "  pscreen --debug            - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º"
    echo "  pscreen --fix              - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã"
    exit 0
fi

if [ "$1" = "--debug" ]; then
    echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ PScreen v1.0.4..."
    echo ""
    echo "üìä –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
    echo "   Node.js: $(node --version 2>/dev/null || echo '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
    echo "   npm: $(npm --version 2>/dev/null || echo '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
    echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $APP_DIR"
    echo "   –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: /var/lib/pscreen/results"
    
    echo ""
    echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤:"
    for file in "src/cli/index.js" "src/server/index.js" "config/default.js" "package.json"; do
        if [ -f "$APP_DIR/$file" ]; then
            echo "   ‚úÖ $file"
        else
            echo "   ‚ùå $file"
        fi
    done
    
    echo ""
    echo "üìÇ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:"
    if [ -d "/var/lib/pscreen/results" ]; then
        echo "   ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç"
        echo "   üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: $(ls /var/lib/pscreen/results 2>/dev/null | wc -l) —ç–ª–µ–º–µ–Ω—Ç–æ–≤"
    else
        echo "   ‚ùå –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    fi
    
    echo ""
    echo "üîß –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
    ps aux | grep "node.*pscreen\|node.*src" | grep -v grep || echo "   –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
    
    exit 0
fi

if [ "$1" = "--fix" ]; then
    echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º PScreen v1.0.4..."
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    sudo mkdir -p /var/lib/pscreen/results 2>/dev/null || mkdir -p /var/lib/pscreen/results
    sudo chmod 755 /var/lib/pscreen/results 2>/dev/null || chmod 755 /var/lib/pscreen/results
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
    sudo pkill -f "node.*pscreen\|node.*src" 2>/dev/null || pkill -f "node.*pscreen\|node.*src" 2>/dev/null || true
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    if [ ! -d "node_modules" ]; then
        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        npm install --production --force 2>/dev/null || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
    fi
    
    echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    echo "üöÄ –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏—Ç–µ: pscreen"
    exit 0
fi

if [ "$1" = "serve-standalone" ]; then
    echo "üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞..."
    shift
    node src/server/index.js "$@"
    exit $?
fi

# –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω URL –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç
if [ "$1" ] && [ "$1" != "serve" ]; then
    echo "üéØ –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –¥–ª—è: $1"
    node src/cli/index.js take "$1" --width 1920 --height 1080 --fullPage true --server true
    exit $?
fi

# –ö–æ–º–∞–Ω–¥–∞ serve
if [ "$1" = "serve" ]; then
    shift
    echo "üöÄ –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞..."
    node src/cli/index.js serve "$@"
    exit $?
fi

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
echo "üéØ PScreen v1.0.4 - –£–ª—É—á—à–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤"
echo "======================================================="

read -p "üåê –í–≤–µ–¥–∏—Ç–µ URL —Å–∞–π—Ç–∞: " url
if [ -z "$url" ]; then
    echo "‚ùå URL –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    exit 1
fi

echo ""
echo "üìê –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:"
read -p "   –®–∏—Ä–∏–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1920): " width
width=${width:-1920}

read -p "   –í—ã—Å–æ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1080): " height  
height=${height:-1080}

read -p "   –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞? (y/N): " fullpage
if [[ "$fullpage" =~ ^[Yy]$ ]]; then
    fullpage="true"
else
    fullpage="false"
fi

read -p "   –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä? (Y/n): " server
if [[ "$server" =~ ^[Nn]$ ]]; then
    server="false"
else
    server="true"
fi

echo ""
echo "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞..."
echo "   URL: $url"
echo "   –†–∞–∑–º–µ—Ä: ${width}x${height}"
echo "   –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: $fullpage"
echo "   –í–µ–±-—Å–µ—Ä–≤–µ—Ä: $server"
echo ""

node src/cli/index.js take "$url" --width "$width" --height "$height" --fullPage "$fullpage" --server "$server"
