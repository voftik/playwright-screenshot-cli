// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è DevOps
require("dotenv").config();
const logger = require("./lib/logger");
const metrics = require("./lib/metrics");
const TemplateRenderer = require("./lib/templateRenderer");
const templateRenderer = new TemplateRenderer();

const express = require('express');
const cors = require('cors');
const path = require('path');
const fs = require('fs');
const { getExternalIp, getConfig, updateConfig, clearCache, getCacheInfo } = require('./lib/getExternalIp');

const app = express();
const PORT = process.env.PORT || 9000;
const RESULTS_DIR = path.join(__dirname, 'results');

// Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
const corsOptions = {
    origin: function (origin, callback) {
        // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ origin (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)
        // –∏ –∑–∞–ø—Ä–æ—Å—ã —Å localhost, 127.0.0.1, –∞ —Ç–∞–∫–∂–µ —Å –≤–Ω–µ—à–Ω–∏—Ö IP
        const allowedOrigins = [
            /^https?:\/\/localhost(:\d+)?$/,
            /^https?:\/\/127\.0\.0\.1(:\d+)?$/,
            /^https?:\/\/192\.168\.\d+\.\d+(:\d+)?$/,
            /^https?:\/\/10\.\d+\.\d+\.\d+(:\d+)?$/,
            /^https?:\/\/172\.(1[6-9]|2\d|3[01])\.\d+\.\d+(:\d+)?$/
        ];
        
        if (!origin || allowedOrigins.some(pattern => pattern.test(origin))) {
            callback(null, true);
        } else {
            // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã —Å –≤–Ω–µ—à–Ω–∏—Ö IP, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ getExternalIp
//             getExternalIp().then(ipInfo => {
//                 const externalIpPattern = new RegExp(`^https?://${ipInfo.ip.replace(/\./g, '\\.')}(:\\d+)?$`);
//                 if (externalIpPattern.test(origin)) {
//                     callback(null, true);
//                 } else {
//                     console.warn(`CORS: –ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∑–∞–ø—Ä–æ—Å —Å origin: ${origin}`);
//                     callback(new Error('Not allowed by CORS'));
//                 }
//             }).catch(() => {
//                 console.warn(`CORS: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π IP –¥–ª—è origin: ${origin}`);
//                 callback(new Error('Not allowed by CORS'));
//             });
        }
    },
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
};

app.use(cors(corsOptions));

// –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫
app.use(metrics.middleware);

// Middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ JSON
app.use(express.json());

// Middleware –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ IP –∫–ª–∏–µ–Ω—Ç–∞
app.use((req, res, next) => {
    req.clientIp = req.headers['x-forwarded-for'] || 
                   req.headers['x-real-ip'] || 
                   req.connection.remoteAddress || 
                   req.socket.remoteAddress ||
                   (req.connection.socket ? req.connection.socket.remoteAddress : null);
    next();
});

// –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é results –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
if (!fs.existsSync(RESULTS_DIR)) {
    fs.mkdirSync(RESULTS_DIR, { recursive: true });
}

// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
app.use('/static', express.static(RESULTS_DIR));

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ URL —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º IP
async function getBaseUrl(req) {
    try {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Host –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        if (req.get('Host')) {
            const protocol = req.secure || req.get('X-Forwarded-Proto') === 'https' ? 'https' : 'http';
            return `${protocol}://${req.get('Host')}`;
        }
        
        // –ï—Å–ª–∏ Host –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω–µ—à–Ω–∏–π IP
        const ipInfo = await getExternalIp();
        const protocol = req.secure ? 'https' : 'http';
        const port = PORT !== 80 && PORT !== 443 ? `:${PORT}` : '';
        return `${protocol}://${ipInfo.ip}${port}`;
    } catch (error) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±–∞–∑–æ–≤—ã–π URL, –∏—Å–ø–æ–ª—å–∑—É–µ–º localhost:', error.message);
        const protocol = req.secure ? 'https' : 'http';
        const port = PORT !== 80 && PORT !== 443 ? `:${PORT}` : '';
        return `${protocol}://localhost${port}`;
    }
}

// Health check endpoint
app.get("/health", (req, res) => {
    const uptime = process.uptime();
    const memUsage = process.memoryUsage();
    
    res.status(200).json({
        status: "UP",
        timestamp: new Date().toISOString(),
        uptime: `${Math.floor(uptime)}s`,
        memory: {
            rss: `${Math.round(memUsage.rss / 1024 / 1024)}MB`,
            heapTotal: `${Math.round(memUsage.heapTotal / 1024 / 1024)}MB`,
            heapUsed: `${Math.round(memUsage.heapUsed / 1024 / 1024)}MB`
        },
        environment: process.env.NODE_ENV || "development"
    });
});

// Metrics endpoint –¥–ª—è Prometheus
app.get("/metrics", async (req, res) => {
    res.set("Content-Type", metrics.getRegister().contentType);
    res.end(await metrics.getMetrics());
});


// API —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ IP
app.get('/api/external-ip', async (req, res) => {
    try {
        const forceRefresh = req.query.force === 'true';
        const result = await getExternalIp({ forceRefresh });
        const baseUrl = await getBaseUrl(req);
        
        res.json({
            success: true,
            data: {
                ...result,
                baseUrl: baseUrl,
                serverInfo: {
                    port: PORT,
                    protocol: req.secure ? 'https' : 'http'
                }
            }
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤–Ω–µ—à–Ω–µ–≥–æ IP:', error);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// API —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–µ—à–µ
app.get('/api/cache-info', (req, res) => {
    try {
        const cacheInfo = getCacheInfo();
        res.json({
            success: true,
            data: cacheInfo
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–µ—à–µ:', error);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// API —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞
app.post('/api/cache/clear', (req, res) => {
    try {
        clearCache();
        res.json({
            success: true,
            message: '–ö–µ—à –æ—á–∏—â–µ–Ω'
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–µ—à–∞:', error);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// API —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
app.get('/api/config', async (req, res) => {
    try {
        const config = await getConfig();
        res.json({
            success: true,
            data: config
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', error);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// API —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
app.post('/api/config', async (req, res) => {
    try {
        const newConfig = await updateConfig(req.body);
        res.json({
            success: true,
            data: newConfig
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', error);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
// –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º EJS —à–∞–±–ª–æ–Ω–æ–≤
app.get("/", async (req, res) => {
    try {
        const domainsRaw = fs.readdirSync(RESULTS_DIR, { withFileTypes: true })
            .filter(dirent => dirent.isDirectory())
            .map(dirent => dirent.name);

        // –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π IP –∏ –±–∞–∑–æ–≤—ã–π URL –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        let externalIpInfo = null;
        let baseUrl = null;
        try {
            externalIpInfo = await getExternalIp();
            baseUrl = await getBaseUrl(req);
        } catch (error) {
            logger.warn("Failed to get external IP for dashboard", { error: error.message });
        }

        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–∞
        const templateData = {
            domainsRaw,
            externalIpInfo,
            baseUrl,
            resultsDir: RESULTS_DIR
        };

        // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–æ–º–æ—â—å—é EJS
        const html = await templateRenderer.renderDashboard(templateData);
        res.send(html);
    } catch (error) {
        logger.error("Error rendering dashboard", { error: error.message, stack: error.stack });
        res.status(500).send(`–û—à–∏–±–∫–∞: ${error.message}`);
    }
});
// –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥)

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 404
app.use((req, res) => {
    logger.warn('404 - Page not found', { 
        method: req.method, 
        url: req.originalUrl, 
        ip: req.clientIp 
    });
    res.status(404).json({
        success: false,
        error: '–≠–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω',
        method: req.method,
        path: req.originalUrl
    });
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
app.use((err, req, res, next) => {
    logger.error('Server error', { 
        error: err.message, 
        stack: err.stack,
        url: req.originalUrl,
        method: req.method
    });
    res.status(500).json({
        success: false,
        error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
        details: process.env.NODE_ENV === 'development' ? err.message : undefined
    });
});

// Graceful shutdown
function gracefulShutdown(signal) {
    logger.info('Received shutdown signal', { signal });
    
    const shutdownTimeout = parseInt(process.env.SHUTDOWN_TIMEOUT) || 30000;
    
    setTimeout(() => {
        logger.error('Forced shutdown due to timeout');
        process.exit(1);
    }, shutdownTimeout);
    
    logger.info('Shutting down gracefully');
    // process.exit(0); // Will exit after timeout
}

process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
process.on('uncaughtException', (error) => {
    logger.error('Uncaught Exception', { error: error.message, stack: error.stack });
    process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
    logger.error('Unhandled Rejection', { reason, promise });
    process.exit(1);
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const server = app.listen(PORT, '0.0.0.0', () => {
    logger.info('Screenshots web server started', {
        port: PORT,
        host: '0.0.0.0',
        environment: process.env.NODE_ENV || 'development',
        resultsDir: RESULTS_DIR
    });
    
    console.log(`üåê Screenshots web server –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://0.0.0.0:${PORT}`);
    console.log('üìã DevOps —Ñ—É–Ω–∫—Ü–∏–∏:');
    console.log('   - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Winston)');
    console.log('   - Health check: /health');
    console.log('   - Prometheus –º–µ—Ç—Ä–∏–∫–∏: /metrics');
    console.log('   - Graceful shutdown');
    console.log('   - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)');
    console.log('   - –£–ª—É—á—à–µ–Ω–Ω—ã–π UI —Å EJS —à–∞–±–ª–æ–Ω–∞–º–∏');
    
    // –õ–æ–≥–∏—Ä—É–µ–º –≤–Ω–µ—à–Ω–∏–π IP –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
//     getExternalIp().then(ipInfo => {
//         logger.externalIp(ipInfo);
//         metrics.recordExternalIpCheck(ipInfo.source, false);
//         console.log(`üîó –í–Ω–µ—à–Ω–∏–π IP: ${ipInfo.ip} (–∏—Å—Ç–æ—á–Ω–∏–∫: ${ipInfo.source})`);
//         console.log(`üåç –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø: http://${ipInfo.ip}:${PORT}`);
//     }).catch(error => {
//         logger.warn('Failed to get external IP on startup', { error: error.message });

module.exports = { app, server };
    // –õ–æ–≥–∏—Ä—É–µ–º –≤–Ω–µ—à–Ω–∏–π IP –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã)
    console.log('üîó –í–Ω–µ—à–Ω–∏–π IP –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ');
});

