#!/bin/bash

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PScreen v1.0.3..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
cd /usr/local/lib/pscreen

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
if [ ! -d "node_modules" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    npm install --production --silent 2>/dev/null || {
        echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ npm, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è..."
        npm install --production
    }
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Playwright –±—Ä–∞—É–∑–µ—Ä—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
if [ ! -d "node_modules/playwright/.local-browsers" ]; then
    echo "üåê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright..."
    npx playwright install chromium --with-deps >/dev/null 2>&1 || {
        echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è..."
        npx playwright install chromium --with-deps
    }
fi

# –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º –∫–æ–¥–µ
echo "üî® –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º –∫–æ–¥–µ..."
if [ -f "src/server/index.js" ]; then
    # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
    cp src/server/index.js src/server/index.js.backup-postinst
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    sed -i 's|path\.join(process\.cwd(), config\.screenshot\.outputDir)|config.screenshot.outputDir|g' src/server/index.js
    sed -i 's|path\.join(process\.cwd(), config\.screenshot\.outputDir, domain, timestamp)|path.join(config.screenshot.outputDir, domain, timestamp)|g' src/server/index.js  
    sed -i 's|path\.join(process\.cwd(), config\.screenshot\.outputDir, domain, timestamp, screenshot)|path.join(config.screenshot.outputDir, domain, timestamp, screenshot)|g' src/server/index.js
    
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω"
fi

# –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
mkdir -p /var/lib/pscreen/results
chmod 755 /var/lib/pscreen/results

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f "node.*src/server" 2>/dev/null || true

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod +x /usr/local/bin/pscreen
chmod -R 755 /usr/local/lib/pscreen

echo "‚úÖ PScreen v1.0.3 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üîß –£–ª—É—á—à–µ–Ω–∏—è –≤ v1.0.3:"
echo "   ‚Ä¢ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É—Ç–µ–π –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ"
echo "   ‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (pscreen --debug)"
echo "   ‚Ä¢ –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (pscreen --fix)"
echo "   ‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ 404"
echo ""
echo "üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
echo "   pscreen              - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"
echo "   pscreen <url>        - –ë—ã—Å—Ç—Ä—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç"  
echo "   pscreen --debug      - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º"
echo "   pscreen --fix        - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã"

exit 0
