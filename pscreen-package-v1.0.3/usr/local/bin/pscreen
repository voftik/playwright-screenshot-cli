#!/bin/bash

# PScreen CLI Tool v1.0.3
APP_DIR="/usr/local/lib/pscreen"

if [ ! -d "$APP_DIR" ]; then
    echo "‚ùå PScreen –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    exit 1
fi

cd "$APP_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
if [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
    echo "PScreen CLI Tool v1.0.3"
    exit 0
fi

if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "PScreen - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –≤–µ–±-—Å–∞–π—Ç–æ–≤"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  pscreen                    - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"
    echo "  pscreen <url>              - –ë—ã—Å—Ç—Ä—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç URL"
    echo "  pscreen --version          - –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é"
    echo "  pscreen --help             - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"
    echo "  pscreen --fix              - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—É—Ç—è–º–∏"
    echo "  pscreen --debug            - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º"
    exit 0
fi

if [ "$1" = "--debug" ]; then
    echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ PScreen..."
    echo ""
    echo "üìä –í–µ—Ä—Å–∏—è: $(basename $0) v1.0.3"
    echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $APP_DIR"
    echo "üìÇ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: /var/lib/pscreen/results"
    
    if [ -d "/var/lib/pscreen/results" ]; then
        echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        echo "   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: $(ls /var/lib/pscreen/results 2>/dev/null | wc -l) —ç–ª–µ–º–µ–Ω—Ç–æ–≤"
    else
        echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    fi
    
    echo ""
    echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞:"
    if grep -q "path\.join(process\.cwd(), config\.screenshot\.outputDir)" src/server/index.js 2>/dev/null; then
        echo "‚ùå –°–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—É—Ç–∏"
        echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: pscreen --fix"
    else
        echo "‚úÖ –°–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω"
    fi
    
    echo ""
    echo "üì° –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Å–µ—Ä–≤–µ—Ä–∞:"
    ps aux | grep "node.*src/server" | grep -v grep || echo "   –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤"
    
    exit 0
fi

if [ "$1" = "--fix" ]; then
    echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –ø—É—Ç—è–º–∏..."
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    sudo mkdir -p /var/lib/pscreen/results 2>/dev/null || mkdir -p /var/lib/pscreen/results
    sudo chmod 755 /var/lib/pscreen/results 2>/dev/null || chmod 755 /var/lib/pscreen/results
    
    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ —Å–µ—Ä–≤–µ—Ä–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if grep -q "path\.join(process\.cwd(), config\.screenshot\.outputDir)" src/server/index.js 2>/dev/null; then
        echo "üî® –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ–¥..."
        
        # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
        cp src/server/index.js src/server/index.js.backup-$(date +%s)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        sed -i 's|path\.join(process\.cwd(), config\.screenshot\.outputDir)|config.screenshot.outputDir|g' src/server/index.js
        sed -i 's|path\.join(process\.cwd(), config\.screenshot\.outputDir, domain, timestamp)|path.join(config.screenshot.outputDir, domain, timestamp)|g' src/server/index.js
        sed -i 's|path\.join(process\.cwd(), config\.screenshot\.outputDir, domain, timestamp, screenshot)|path.join(config.screenshot.outputDir, domain, timestamp, screenshot)|g' src/server/index.js
        
        echo "‚úÖ –°–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω"
    fi
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    sudo pkill -f "node.*src/server" 2>/dev/null || pkill -f "node.*src/server" 2>/dev/null || true
    
    echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    echo "üöÄ –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏—Ç–µ: pscreen"
    exit 0
fi

# –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω URL –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç
if [ "$1" ]; then
    echo "üéØ –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –¥–ª—è: $1"
    node src/cli/index.js take "$1" --width 1920 --height 1080 --fullPage true --server true
    exit $?
fi

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
echo "üéØ PScreen - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤"
echo "=============================================="

read -p "üåê –í–≤–µ–¥–∏—Ç–µ URL —Å–∞–π—Ç–∞: " url
if [ -z "$url" ]; then
    echo "‚ùå URL –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    exit 1
fi

echo ""
echo "üìê –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:"
read -p "   –®–∏—Ä–∏–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1920): " width
width=${width:-1920}

read -p "   –í—ã—Å–æ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1080): " height  
height=${height:-1080}

read -p "   –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞? (y/N): " fullpage
if [[ "$fullpage" =~ ^[Yy]$ ]]; then
    fullpage="true"
else
    fullpage="false"
fi

read -p "   –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä? (Y/n): " server
if [[ "$server" =~ ^[Nn]$ ]]; then
    server="false"
else
    server="true"
fi

echo ""
echo "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞..."
echo "   URL: $url"
echo "   –†–∞–∑–º–µ—Ä: ${width}x${height}"
echo "   –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: $fullpage"
echo "   –í–µ–±-—Å–µ—Ä–≤–µ—Ä: $server"
echo ""

node src/cli/index.js take "$url" --width "$width" --height "$height" --fullPage "$fullpage" --server "$server"
