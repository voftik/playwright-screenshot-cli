#!/bin/bash

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PScreen v1.0.2..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
cd /usr/local/lib/pscreen

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
if [ ! -d "node_modules" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    npm install --production --silent 2>/dev/null || {
        echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ npm, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è..."
        npm install --production
    }
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Playwright –±—Ä–∞—É–∑–µ—Ä—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
if [ ! -d "node_modules/playwright/.local-browsers" ]; then
    echo "üåê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright..."
    npx playwright install chromium --with-deps >/dev/null 2>&1 || {
        echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è..."
        npx playwright install chromium --with-deps
    }
fi

# –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
mkdir -p /var/lib/pscreen/results
chmod 755 /var/lib/pscreen/results

# –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
mkdir -p /usr/local/lib/pscreen/results 2>/dev/null || true

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f "node.*src/server" 2>/dev/null || true

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod +x /usr/local/bin/pscreen
chmod -R 755 /usr/local/lib/pscreen

echo "‚úÖ PScreen v1.0.2 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ v1.0.2:"
echo "   ‚Ä¢ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—É—Ç–∏ –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º —Ñ–∞–π–ª–∞–º"
echo "   ‚Ä¢ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –æ—à–∏–±–∫–∏ 404 –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ—Å—É—Ä—Å–æ–≤"
echo "   ‚Ä¢ –£–ª—É—á—à–µ–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
echo ""
echo "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–µ: pscreen"
echo "üõ†Ô∏è  –î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º: pscreen --fix"

exit 0
