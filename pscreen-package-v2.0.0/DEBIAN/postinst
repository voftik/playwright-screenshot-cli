#!/bin/bash

echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PScreen v2.0.0..."

cd /usr/local/lib/pscreen

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
if [ ! -d "node_modules" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    npm install --production --silent --force 2>/dev/null || {
        echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ npm..."
        npm install --production --force
    }
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Playwright –±—Ä–∞—É–∑–µ—Ä—ã
if [ ! -d "node_modules/playwright/.local-browsers" ]; then
    echo "üåê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright..."
    npx playwright install chromium --with-deps >/dev/null 2>&1 || {
        echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright..."
        npx playwright install chromium --with-deps
    }
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
mkdir -p /var/lib/pscreen/screenshots
mkdir -p /var/log
chmod 755 /var/lib/pscreen/screenshots

# –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "/etc/pscreen/config.json" ]; then
    mkdir -p /etc/pscreen
    cat > /etc/pscreen/config.json << 'CONFIG_EOF'
{
  "screenshot": {
    "outputDir": "/var/lib/pscreen/screenshots",
    "width": 1920,
    "height": 1080,
    "fullPage": true,
    "browser": "chromium",
    "timeout": 30000,
    "format": "png"
  },
  "server": {
    "enabled": true,
    "port": 9000,
    "host": "0.0.0.0",
    "autoStart": true
  },
  "logging": {
    "level": "info",
    "console": true,
    "file": "/var/log/pscreen.log"
  },
  "automation": {
    "retries": 3,
    "parallelLimit": 2,
    "continueOnError": false
  }
}
CONFIG_EOF
    chmod 644 /etc/pscreen/config.json
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f "node.*pscreen\|node.*src" 2>/dev/null || true

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
chmod +x /usr/local/bin/pscreen
chmod -R 755 /usr/local/lib/pscreen

echo "‚úÖ PScreen v2.0.0 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üéØ –ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò v2.0.0:"
echo "   ‚Ä¢ –ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ CI/CD –ø–æ–¥–¥–µ—Ä–∂–∫–∞"
echo "   ‚Ä¢ –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ URL –∏–∑ —Ñ–∞–π–ª–æ–≤"
echo "   ‚Ä¢ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ"
echo "   ‚Ä¢ JSON –≤—ã–≤–æ–¥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏"
echo "   ‚Ä¢ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
echo "   ‚Ä¢ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
echo "   ‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
echo ""
echo "üöÄ –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø:"
echo "   pscreen screenshot https://example.com --json --quiet"
echo "   pscreen screenshot --batch urls.txt --parallel 3"
echo "   pscreen serve --port 9000"
echo "   pscreen config --init"
echo "   pscreen debug"
echo ""
echo "üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: /usr/local/lib/pscreen/docs/README.md"
echo "‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: /etc/pscreen/config.json"

exit 0
